<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Warga K3 - Lapor Bahaya!</title>
    
    <!-- Favicon: Helm Proyek dengan Latar Kuning (Sesuai Header) -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Crect width='32' height='32' rx='8' fill='%23eab308'/%3E%3Cpath fill='%230f172a' d='M16 6c-5.5 0-10 4.5-10 10v4h20v-4c0-5.5-4.5-10-10-10z M4 20h24v4h-24z'/%3E%3C/svg%3E">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; }
        .mobile-container { max-width: 480px; margin: 0 auto; }
        .hidden-view { display: none !important; }
        .glass-effect {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
        }
        /* Loading Spinner */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #fbbf24;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <!-- Navbar Sederhana -->
    <nav class="bg-slate-900 text-white shadow-lg sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <div class="bg-yellow-500 p-1.5 rounded-lg">
                    <i class="fa-solid fa-hard-hat text-slate-900 text-lg"></i>
                </div>
                <span class="font-bold text-lg tracking-wide">Warga<span class="text-yellow-500">K3</span></span>
            </div>
            <div>
                <button onclick="switchView('user')" id="btn-user-view" class="text-sm px-3 py-1 rounded-md bg-yellow-500 text-slate-900 font-bold hidden">
                    <i class="fa-solid fa-mobile-screen mr-1"></i> Mode Lapor
                </button>
                <button onclick="attemptAdminLogin()" id="btn-admin-view" class="text-sm px-3 py-1 rounded-md hover:bg-slate-700 transition">
                    <i class="fa-solid fa-lock mr-1"></i> Mode Admin
                </button>
            </div>
        </div>
    </nav>

    <!-- ========================== VIEW USER (PELAPOR) ========================== -->
    <div id="view-user" class="min-h-screen pb-20">
        
        <!-- Hero Section -->
        <div class="bg-slate-900 text-white pt-8 pb-16 px-6 rounded-b-[2.5rem] relative overflow-hidden">
            <div class="absolute top-0 right-0 opacity-10 transform translate-x-10 -translate-y-10">
                <i class="fa-solid fa-triangle-exclamation text-9xl"></i>
            </div>
            <div class="mobile-container relative z-10">
                <h1 class="text-2xl font-bold mb-2">Lihat Bahaya?</h1>
                <p class="text-slate-300 text-sm mb-6">Jangan diam! Jadilah pahlawan keselamatan dengan melaporkan kondisi tidak aman di sekitarmu.</p>
                
                <!-- Status Card -->
                <div class="bg-white/10 backdrop-blur-md rounded-xl p-4 border border-white/20 flex items-center justify-between">
                    <div>
                        <p class="text-xs text-yellow-400 uppercase font-bold">Total Laporan Warga</p>
                        <p class="text-2xl font-bold" id="user-contribution-count">0</p>
                    </div>
                    <div class="bg-yellow-500 text-slate-900 w-10 h-10 rounded-full flex items-center justify-center">
                        <i class="fa-solid fa-users"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Form Laporan -->
        <div class="mobile-container px-4 -mt-8 relative z-20">
            <div class="bg-white rounded-2xl shadow-xl p-6 border border-gray-100">
                <h2 class="font-bold text-gray-800 text-lg mb-4 flex items-center">
                    <i class="fa-solid fa-camera text-yellow-500 mr-2"></i> Buat Laporan Baru
                </h2>

                <form id="reportForm" class="space-y-4">
                    
                    <!-- Kategori -->
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Kategori Bahaya</label>
                        <div class="grid grid-cols-4 gap-2">
                            <label class="cursor-pointer">
                                <input type="radio" name="category" value="Fisik" class="peer sr-only" checked>
                                <div class="p-2 border rounded-lg text-center peer-checked:bg-yellow-50 peer-checked:border-yellow-500 peer-checked:text-yellow-700 hover:bg-gray-50 transition">
                                    <i class="fa-solid fa-person-falling-burst mb-1 block"></i>
                                    <span class="text-[10px]">Fisik</span>
                                </div>
                            </label>
                            <label class="cursor-pointer">
                                <input type="radio" name="category" value="Listrik" class="peer sr-only">
                                <div class="p-2 border rounded-lg text-center peer-checked:bg-yellow-50 peer-checked:border-yellow-500 peer-checked:text-yellow-700 hover:bg-gray-50 transition">
                                    <i class="fa-solid fa-bolt mb-1 block"></i>
                                    <span class="text-[10px]">Listrik</span>
                                </div>
                            </label>
                            <label class="cursor-pointer">
                                <input type="radio" name="category" value="Kimia/Api" class="peer sr-only">
                                <div class="p-2 border rounded-lg text-center peer-checked:bg-yellow-50 peer-checked:border-yellow-500 peer-checked:text-yellow-700 hover:bg-gray-50 transition">
                                    <i class="fa-solid fa-fire mb-1 block"></i>
                                    <span class="text-[10px]">Api</span>
                                </div>
                            </label>
                            <label class="cursor-pointer">
                                <input type="radio" name="category" value="Lainnya" class="peer sr-only">
                                <div class="p-2 border rounded-lg text-center peer-checked:bg-yellow-50 peer-checked:border-yellow-500 peer-checked:text-yellow-700 hover:bg-gray-50 transition">
                                    <i class="fa-solid fa-question mb-1 block"></i>
                                    <span class="text-[10px]">Lainnya</span>
                                </div>
                            </label>
                        </div>
                    </div>

                    <!-- Lokasi -->
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Lokasi Temuan</label>
                        <input type="text" id="locationInput" placeholder="Ketik lokasi spesifik (Contoh: Lobby, Gudang, dll)..." class="w-full bg-gray-50 border border-gray-200 rounded-lg px-4 py-2 text-sm focus:outline-none focus:border-yellow-500 focus:ring-1 focus:ring-yellow-500" required>
                    </div>

                    <!-- Deskripsi -->
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Detail Masalah</label>
                        <textarea id="descriptionInput" rows="3" placeholder="Contoh: Kabel terkelupas di dekat dispenser air..." class="w-full bg-gray-50 border border-gray-200 rounded-lg px-4 py-2 text-sm focus:outline-none focus:border-yellow-500 focus:ring-1 focus:ring-yellow-500" required></textarea>
                    </div>

                    <!-- Bukti Foto -->
                    <div>
                         <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Bukti Foto</label>
                         <div class="relative border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:bg-gray-50 transition group cursor-pointer" onclick="document.getElementById('fileInput').click()">
                             <input type="file" id="fileInput" class="hidden" accept="image/*">
                             <i class="fa-solid fa-cloud-arrow-up text-2xl text-gray-400 group-hover:text-yellow-500 mb-2"></i>
                             <p class="text-xs text-gray-500" id="fileName">Ketuk untuk ambil foto</p>
                         </div>
                    </div>

                    <!-- Tombol Kirim -->
                    <button type="submit" id="submitBtn" class="w-full bg-slate-900 hover:bg-slate-800 text-white font-bold py-3 rounded-xl shadow-lg shadow-slate-900/20 active:scale-95 transition-all flex justify-center items-center">
                        <span id="btnText">KIRIM LAPORAN</span>
                        <div id="btnLoader" class="loader ml-2 hidden" style="width: 20px; height: 20px; border-width: 2px;"></div>
                    </button>
                </form>
            </div>

            <!-- Feed Laporan Terbaru -->
            <div class="mt-8">
                <h3 class="font-bold text-gray-700 mb-3 px-2">Laporan Terkini Warga</h3>
                <div id="recentReports" class="space-y-3 pb-10">
                    <!-- Data populated by JS -->
                    <div class="animate-pulse flex space-x-4 p-4 bg-white rounded-xl">
                        <div class="rounded-full bg-gray-200 h-10 w-10"></div>
                        <div class="flex-1 space-y-2 py-1">
                            <div class="h-4 bg-gray-200 rounded w-3/4"></div>
                            <div class="h-4 bg-gray-200 rounded w-1/2"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ========================== VIEW ADMIN (DASHBOARD) ========================== -->
    <div id="view-admin" class="min-h-screen bg-gray-100 p-6 hidden-view">
        <div class="max-w-7xl mx-auto">
            
            <div class="flex justify-between items-end mb-8">
                <div>
                    <h1 class="text-3xl font-bold text-slate-800">Dashboard K3</h1>
                    <p class="text-slate-500">Monitoring kondisi K3 area secara real-time.</p>
                </div>
                <div class="text-right">
                    <p class="text-sm text-gray-500">Last Update</p>
                    <p class="font-mono text-slate-800 font-bold" id="lastUpdateClock">--:--:--</p>
                </div>
            </div>

            <!-- Stats Cards -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                <!-- Card Total -->
                <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-slate-800">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-xs text-gray-500 uppercase font-bold">Total Laporan</p>
                            <h3 class="text-3xl font-bold text-slate-800 mt-1" id="stat-total">0</h3>
                        </div>
                        <div class="bg-slate-100 p-2 rounded-lg text-slate-600">
                            <i class="fa-solid fa-list-ul"></i>
                        </div>
                    </div>
                </div>
                <!-- Card Open -->
                <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-red-500">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-xs text-gray-500 uppercase font-bold">Bahaya Aktif</p>
                            <h3 class="text-3xl font-bold text-red-600 mt-1" id="stat-open">0</h3>
                        </div>
                        <div class="bg-red-50 p-2 rounded-lg text-red-500">
                            <i class="fa-solid fa-circle-exclamation"></i>
                        </div>
                    </div>
                </div>
                <!-- Card Process -->
                <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-yellow-500">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-xs text-gray-500 uppercase font-bold">Sedang Ditangani</p>
                            <h3 class="text-3xl font-bold text-yellow-600 mt-1" id="stat-process">0</h3>
                        </div>
                        <div class="bg-yellow-50 p-2 rounded-lg text-yellow-500">
                            <i class="fa-solid fa-screwdriver-wrench"></i>
                        </div>
                    </div>
                </div>
                <!-- Card Done -->
                <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-green-500">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-xs text-gray-500 uppercase font-bold">Terselesaikan</p>
                            <h3 class="text-3xl font-bold text-green-600 mt-1" id="stat-done">0</h3>
                        </div>
                        <div class="bg-green-50 p-2 rounded-lg text-green-500">
                            <i class="fa-solid fa-check-circle"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Content Grid -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                
                <!-- Table Section (Takes 2 columns) -->
                <div class="lg:col-span-2 bg-white rounded-xl shadow-sm overflow-hidden">
                    <div class="px-6 py-4 border-b border-gray-100 flex justify-between items-center">
                        <h3 class="font-bold text-slate-800">Daftar Laporan Masuk</h3>
                        <div class="relative">
                            <input type="text" id="searchInput" placeholder="Cari lokasi..." class="pl-8 pr-4 py-1 text-sm border rounded-lg focus:outline-none focus:border-yellow-500">
                            <i class="fa-solid fa-search absolute left-2.5 top-2 text-gray-400 text-xs"></i>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left text-gray-500">
                            <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                                <tr>
                                    <th scope="col" class="px-6 py-3">Waktu</th>
                                    <th scope="col" class="px-6 py-3">Lokasi</th>
                                    <th scope="col" class="px-6 py-3">Kategori</th>
                                    <th scope="col" class="px-6 py-3">Bukti</th>
                                    <th scope="col" class="px-6 py-3">Status</th>
                                    <th scope="col" class="px-6 py-3">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="adminTableBody">
                                <!-- Data rows injected here -->
                            </tbody>
                        </table>
                    </div>
                    <div id="emptyState" class="hidden p-8 text-center">
                        <i class="fa-regular fa-folder-open text-4xl text-gray-300 mb-2"></i>
                        <p class="text-gray-400">Belum ada data laporan.</p>
                    </div>
                </div>

                <!-- Chart & Analytics Section (Takes 1 column) -->
                <div class="space-y-6">
                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <h3 class="font-bold text-slate-800 mb-4">Tren Kategori Bahaya</h3>
                        <div class="h-48">
                            <canvas id="categoryChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="bg-slate-900 text-white rounded-xl shadow-sm p-6">
                        <h3 class="font-bold text-yellow-500 mb-2">AI Insight (Real-Time Calc)</h3>
                        <p class="text-sm text-slate-300 leading-relaxed" id="aiInsightText">
                            <i class="fa-solid fa-circle-notch fa-spin"></i> Menganalisa data...
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- SCRIPT UTAMA - GOOGLE SHEETS VERSION -->
    <script>
        // ================= CONFIGURATION =================
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyATl_0eVv5BHHxdL8jzrB-KLcNf661mjyUqJAtNWC-aWyIxrfzXhdlPcdvQIAYCcAM/exec';

        // Variabel Global
        let currentUser = localStorage.getItem('wargaK3_userId');
        let isAdminLoggedIn = false; 
        let chartInstance = null;
        let lastReports = [];

        // Mock Data Storage untuk Mode Demo
        let mockReports = [
            {
                id: 'mock1',
                category: 'Fisik',
                location: 'Lobby Utama',
                description: 'Lantai basah licin tanpa tanda peringatan',
                imageUrl: 'https://images.unsplash.com/photo-1584650589355-e8b987a0e309?w=150&q=80', // Dummy Image
                status: 'Open',
                userId: 'other_user',
                timestamp: new Date(Date.now() - 3600000).toISOString()
            },
            {
                id: 'mock2',
                category: 'Listrik',
                location: 'Ruang Server',
                description: 'Stopkontak terlihat gosong',
                imageUrl: '',
                status: 'In Progress',
                userId: 'other_user',
                timestamp: new Date(Date.now() - 86400000).toISOString()
            }
        ];

        if (!currentUser) {
            currentUser = 'user_' + Math.random().toString(36).substr(2, 9);
            localStorage.setItem('wargaK3_userId', currentUser);
        }

        // ================= HELPER: Convert File to Base64 =================
        const toBase64 = file => new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result);
            reader.onerror = error => reject(error);
        });

        // ================= DATA FETCHING (POLLING SYSTEM) =================
        async function fetchReports() {
            if (SCRIPT_URL.includes('PLACEHOLDER')) {
                lastReports = mockReports;
                updateUserFeed(mockReports);
                updateAdminDashboard(mockReports);
                generateAIInsight(mockReports); // Panggil AI Insight
                return;
            }

            try {
                const response = await fetch(`${SCRIPT_URL}?action=get`);
                const result = await response.json();
                
                if (result.status === 'success') {
                    const reports = result.data;
                    console.log('Data diterima dari Sheet:', reports); // DEBUG
                    if (reports.length > 0) {
                        console.log('Sample Keys:', Object.keys(reports[0])); // DEBUG: Lihat nama kolom sebenarnya
                    }
                    lastReports = reports;
                    updateUserFeed(reports);
                    updateAdminDashboard(reports);
                    generateAIInsight(reports); // Panggil AI Insight
                }
            } catch (error) {
                console.error("Gagal mengambil data:", error);
            }
        }

        // Mulai Polling
        setInterval(fetchReports, 5000);
        fetchReports();

        // ================= AI INSIGHT GENERATOR (LOGIKA STATISTIK) =================
        function generateAIInsight(reports) {
            const insightEl = document.getElementById('aiInsightText');
            
            if (!reports || reports.length === 0) {
                insightEl.innerHTML = "Belum ada cukup data untuk dianalisa.";
                return;
            }

            // 1. Hitung Kategori Terbanyak
            const catCounts = {};
            reports.forEach(r => catCounts[r.category] = (catCounts[r.category] || 0) + 1);
            
            let topCat = '';
            let maxCount = 0;
            for (const cat in catCounts) {
                if (catCounts[cat] > maxCount) {
                    maxCount = catCounts[cat];
                    topCat = cat;
                }
            }

            // 2. Hitung Lokasi Terbanyak (untuk kategori tersebut)
            const locCounts = {};
            reports.filter(r => r.category === topCat).forEach(r => {
                locCounts[r.location] = (locCounts[r.location] || 0) + 1;
            });

            let topLoc = '';
            let maxLocCount = 0;
            for (const loc in locCounts) {
                if (locCounts[loc] > maxLocCount) {
                    maxLocCount = locCounts[loc];
                    topLoc = loc;
                }
            }

            // 3. Generate Kalimat Insight
            const total = reports.length;
            const percentage = Math.round((maxCount / total) * 100);

            let insightHTML = `
                Dari total <span class="text-white font-bold">${total} laporan</span>, 
                sekitar <span class="text-white font-bold">${percentage}%</span> adalah kategori <span class="text-white font-bold">${topCat}</span>.
                <br><br>
                Area yang paling sering bermasalah adalah <span class="text-white font-bold">${topLoc || 'berbagai lokasi'}</span>.
                Disarankan melakukan inspeksi fokus di area tersebut.
            `;

            insightEl.innerHTML = insightHTML;
        }

        // ================= UI FUNCTIONS: USER VIEW =================
        
        // Handle Form Submit
        const reportForm = document.getElementById('reportForm');
        reportForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const btn = document.getElementById('submitBtn');
            const btnText = document.getElementById('btnText');
            const loader = document.getElementById('btnLoader');
            
            // Get Form Data
            const category = document.querySelector('input[name="category"]:checked').value;
            const location = document.getElementById('locationInput').value; // Ambil dari Text Input
            const description = document.getElementById('descriptionInput').value;
            const fileInput = document.getElementById('fileInput');
            
            // Proses Gambar
            let imageBase64 = "";
            if(fileInput.files.length > 0) {
                const file = fileInput.files[0];
                if(file.size > 2 * 1024 * 1024) {
                    Swal.fire('File Terlalu Besar', 'Maksimal ukuran foto 2MB', 'warning');
                    return;
                }
                try {
                    imageBase64 = await toBase64(file);
                } catch(err) {
                    console.error("Gagal convert gambar", err);
                    Swal.fire('Error', 'Gagal memproses gambar', 'error');
                    return;
                }
            }

            // UI Loading State
            btn.disabled = true;
            btnText.innerText = 'MENGIRIM...';
            loader.classList.remove('hidden');

            try {
                // MODE DEMO
                if (SCRIPT_URL.includes('PLACEHOLDER')) {
                    await new Promise(r => setTimeout(r, 1000));
                    
                    const newReport = {
                        id: 'mock_' + Date.now(),
                        category: category,
                        location: location,
                        description: description,
                        imageUrl: imageBase64, 
                        status: 'Open',
                        userId: currentUser,
                        timestamp: new Date().toISOString()
                    };
                    mockReports.unshift(newReport);
                    fetchReports();

                    Swal.fire({
                        title: 'Laporan Terkirim (Demo)!',
                        text: 'Data disimpan lokal.',
                        icon: 'success',
                        confirmButtonColor: '#fbbf24',
                        confirmButtonText: 'OK'
                    });

                } else {
                    // MODE LIVE
                    const payload = {
                        action: 'create',
                        category: category,
                        location: location,
                        description: description,
                        image: imageBase64,
                        status: 'Open',
                        userId: currentUser,
                        timestamp: new Date().toISOString()
                    };

                    await fetch(SCRIPT_URL, {
                        method: 'POST',
                        mode: 'no-cors', 
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    setTimeout(fetchReports, 2000); 

                    Swal.fire({
                        title: 'Laporan Terkirim!',
                        text: 'Laporan dan bukti foto berhasil dikirim.',
                        icon: 'success',
                        confirmButtonColor: '#fbbf24',
                        confirmButtonText: 'OK'
                    });
                }

                reportForm.reset();
                document.getElementById('fileName').innerText = 'Ketuk untuk ambil foto';

            } catch (error) {
                console.error(error);
                Swal.fire('Gagal', 'Gagal koneksi server.', 'error');
            } finally {
                btn.disabled = false;
                btnText.innerText = 'KIRIM LAPORAN';
                loader.classList.add('hidden');
            }
        });

        document.getElementById('fileInput').addEventListener('change', function(e) {
            if(this.files && this.files[0]) {
                document.getElementById('fileName').innerText = this.files[0].name;
            }
        });

        function updateUserFeed(reports) {
            const feedContainer = document.getElementById('recentReports');
            const userCountEl = document.getElementById('user-contribution-count');
            
            userCountEl.innerText = reports.length;

            feedContainer.innerHTML = '';
            
            const sorted = [...reports].sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));
            const recent = sorted.slice(0, 3);
            
            if (recent.length === 0) {
                feedContainer.innerHTML = '<p class="text-sm text-gray-400 text-center italic">Belum ada laporan. Jadilah yang pertama!</p>';
                return;
            }

            recent.forEach(report => {
                const date = new Date(report.timestamp);
                const timeString = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                
                let statusColor = 'bg-red-100 text-red-600';
                let statusIcon = 'fa-circle-exclamation';
                if(report.status === 'In Progress') { statusColor = 'bg-yellow-100 text-yellow-600'; statusIcon = 'fa-screwdriver-wrench'; }
                if(report.status === 'Done') { statusColor = 'bg-green-100 text-green-600'; statusIcon = 'fa-check'; }

                const html = `
                <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex items-start space-x-3">
                    <div class="h-10 w-10 rounded-full ${statusColor} flex items-center justify-center flex-shrink-0">
                        <i class="fa-solid ${statusIcon}"></i>
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="flex justify-between items-start">
                            <h4 class="text-sm font-bold text-gray-800 truncate">${report.location}</h4>
                            <span class="text-xs text-gray-400">${timeString}</span>
                        </div>
                        <p class="text-xs text-gray-500 truncate">${report.description}</p>
                        <div class="mt-2 flex items-center space-x-2">
                            <span class="text-[10px] uppercase font-bold px-2 py-0.5 rounded bg-gray-100 text-gray-500 border border-gray-200">${report.category}</span>
                            <span class="text-[10px] font-bold ${report.status === 'Open' ? 'text-red-500' : (report.status === 'Done' ? 'text-green-500' : 'text-yellow-500')}">${report.status}</span>
                        </div>
                    </div>
                </div>`;
                feedContainer.innerHTML += html;
            });
        }

        // ================= UI FUNCTIONS: ADMIN VIEW =================

        // Helper untuk melihat gambar besar (Sekarang tidak dipakai karena pakai link)
        window.viewImage = (url) => {
            Swal.fire({
                imageUrl: url,
                imageAlt: 'Bukti Foto',
                showConfirmButton: false,
                showCloseButton: true,
                width: 'auto'
            });
        }

        async function attemptAdminLogin() {
            if(isAdminLoggedIn) {
                switchView('admin');
                return;
            }

            const { value: password } = await Swal.fire({
                title: 'Akses Admin',
                input: 'password',
                inputLabel: 'Masukkan Password Admin',
                inputPlaceholder: 'Password...',
                showCancelButton: true,
                confirmButtonColor: '#0f172a',
                confirmButtonText: 'Masuk'
            });

            if (password) {
                Swal.fire({title: 'Memeriksa...', didOpen: () => Swal.showLoading()});
                
                if (SCRIPT_URL.includes('PLACEHOLDER')) {
                    if(password === 'admin') {
                        isAdminLoggedIn = true;
                        Swal.close();
                        switchView('admin');
                    } else {
                        Swal.fire('Gagal', 'Password salah (Demo: admin)', 'error');
                    }
                } else {
                    try {
                        const response = await fetch(`${SCRIPT_URL}?action=login&password=${encodeURIComponent(password)}`);
                        const result = await response.json();

                        if(result.status === 'success') {
                            isAdminLoggedIn = true;
                            Swal.close();
                            const Toast = Swal.mixin({
                                toast: true, position: 'top-end', showConfirmButton: false, timer: 3000
                            });
                            Toast.fire({ icon: 'success', title: 'Login Berhasil' });
                            switchView('admin');
                        } else {
                            Swal.fire('Akses Ditolak', 'Password salah.', 'error');
                        }
                    } catch (e) {
                        console.error(e);
                        Swal.fire('Error', 'Gagal menghubungi server verifikasi.', 'error');
                    }
                }
            }
        }

        function updateAdminDashboard(reports) {
            const sortedReports = [...reports].sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));

            document.getElementById('stat-total').innerText = reports.length;
            document.getElementById('stat-open').innerText = reports.filter(r => r.status === 'Open').length;
            document.getElementById('stat-process').innerText = reports.filter(r => r.status === 'In Progress').length;
            document.getElementById('stat-done').innerText = reports.filter(r => r.status === 'Done').length;

            const now = new Date();
            document.getElementById('lastUpdateClock').innerText = now.toLocaleTimeString();

            const tbody = document.getElementById('adminTableBody');
            const emptyState = document.getElementById('emptyState');
            tbody.innerHTML = '';

            if (sortedReports.length === 0) {
                emptyState.classList.remove('hidden');
            } else {
                emptyState.classList.add('hidden');
                sortedReports.forEach(report => {
                    const date = new Date(report.timestamp);
                    
                    let statusBadge = '';
                    if(report.status === 'Open') statusBadge = '<span class="bg-red-100 text-red-800 text-xs font-medium px-2.5 py-0.5 rounded border border-red-400">Open</span>';
                    else if(report.status === 'In Progress') statusBadge = '<span class="bg-yellow-100 text-yellow-800 text-xs font-medium px-2.5 py-0.5 rounded border border-yellow-300">Proses</span>';
                    else statusBadge = '<span class="bg-green-100 text-green-800 text-xs font-medium px-2.5 py-0.5 rounded border border-green-400">Selesai</span>';

                    // Cek Gambar & Tampilkan LINK (Request User)
                    let imgButton = '<span class="text-gray-300 text-xs italic">No Link</span>';
                    
                    // SMART KEY DETECTION V3: Super Aggressive Scan
                    // Mencari key 'imageUrl', 'image', 'foto', 'bukti', 'link', 'Image URL'
                    // ATAU mencari value apapun yang dimulai dengan "http"
                    
                    let imgUrl = null;

                    // 1. Cek Key Umum
                    const candidateKeys = ['imageUrl', 'image', 'foto', 'bukti', 'link', 'url', 'file', 'Image URL', 'Bukti Foto'];
                    for (const key of candidateKeys) {
                        if (report[key] && String(report[key]).trim().startsWith('http')) {
                            imgUrl = report[key];
                            break;
                        }
                    }

                    // 2. Fallback: Scan semua value
                    if (!imgUrl) {
                        for (const key in report) {
                            const val = String(report[key]).trim();
                            if (val.startsWith('http') && val.length > 15) {
                                imgUrl = val;
                                break;
                            }
                        }
                    }

                    if(imgUrl) {
                        if(imgUrl.toString().startsWith("Error")) {
                            imgButton = `<span class="text-red-500 text-[10px]" title="${imgUrl}"><i class="fa-solid fa-triangle-exclamation"></i> Gagal</span>`;
                        } else {
                             // Use "Lihat Foto"
                             imgButton = `<a href="${imgUrl}" target="_blank" class="inline-flex items-center px-2.5 py-1.5 bg-blue-50 text-blue-600 rounded-lg text-xs font-bold hover:bg-blue-100 transition border border-blue-200">
                                <i class="fa-regular fa-image mr-1.5"></i> Lihat Foto
                             </a>`;
                        }
                    }

                    const row = `
                    <tr class="bg-white border-b hover:bg-gray-50 transition">
                        <td class="px-6 py-4 whitespace-nowrap text-xs text-gray-500">
                            ${date.toLocaleDateString()} ${date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
                        </td>
                        <td class="px-6 py-4 font-medium text-gray-900">
                            ${report.location}
                        </td>
                        <td class="px-6 py-4">
                            <span class="flex items-center gap-2">
                                <i class="fa-solid fa-circle text-[8px] ${report.category === 'Listrik' ? 'text-yellow-500' : (report.category === 'Fisik' ? 'text-blue-500' : (report.category === 'Lainnya' ? 'text-gray-500' : 'text-red-500'))}"></i>
                                ${report.category}
                            </span>
                        </td>
                        <td class="px-6 py-4">
                            ${imgButton}
                        </td>
                        <td class="px-6 py-4">
                            ${statusBadge}
                        </td>
                        <td class="px-6 py-4">
                            <div class="flex space-x-2">
                                <button onclick="window.updateReportStatus('${report.id}', 'In Progress')" class="text-yellow-500 hover:text-yellow-700 p-1" title="Proses">
                                    <i class="fa-solid fa-screwdriver-wrench"></i>
                                </button>
                                <button onclick="window.updateReportStatus('${report.id}', 'Done')" class="text-green-500 hover:text-green-700 p-1" title="Selesai">
                                    <i class="fa-solid fa-check"></i>
                                </button>
                                <button onclick="window.deleteReport('${report.id}')" class="text-red-500 hover:text-red-700 p-1" title="Hapus">
                                    <i class="fa-solid fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    `;
                    tbody.innerHTML += row;
                });
            }

            updateChart(reports);
        }

        window.deleteReport = async (docId) => {
            const result = await Swal.fire({
                title: 'Hapus Laporan?',
                text: "Data yang dihapus tidak bisa dikembalikan!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#ef4444',
                confirmButtonText: 'Ya, Hapus!'
            });

            if (result.isConfirmed) {
                if (SCRIPT_URL.includes('PLACEHOLDER')) {
                     mockReports = mockReports.filter(r => r.id !== docId);
                     fetchReports();
                     Swal.fire('Terhapus!', 'Data (Demo) telah dihapus.', 'success');
                     return;
                }

                try {
                     await fetch(SCRIPT_URL, {
                        method: 'POST', mode: 'no-cors',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ action: 'delete', id: docId })
                    });

                    Swal.fire('Terhapus!', 'Data telah dihapus.', 'success');
                    setTimeout(fetchReports, 1000);
                } catch (error) {
                    console.error(error);
                    Swal.fire('Error', 'Gagal menghapus data.', 'error');
                }
            }
        };

        window.updateReportStatus = async (docId, newStatus) => {
            if (SCRIPT_URL.includes('PLACEHOLDER')) {
                const report = mockReports.find(r => r.id === docId);
                if (report) {
                    report.status = newStatus;
                    const toast = Swal.mixin({
                        toast: true, position: 'top-end', showConfirmButton: false, timer: 2000, timerProgressBar: true
                    });
                    toast.fire({ icon: 'success', title: `Status diubah ke ${newStatus} (Demo)` });
                    fetchReports();
                }
                return;
            }

            try {
                const payload = { action: 'update', id: docId, status: newStatus };
                await fetch(SCRIPT_URL, {
                    method: 'POST', mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const toast = Swal.mixin({
                    toast: true, position: 'top-end', showConfirmButton: false, timer: 2000, timerProgressBar: true
                });
                toast.fire({ icon: 'success', title: `Status diubah ke ${newStatus}` });
                setTimeout(fetchReports, 1000);
            } catch (error) {
                console.error("Error updating status:", error);
                Swal.fire('Error', 'Gagal update status', 'error');
            }
        };

        function updateChart(reports) {
            const ctx = document.getElementById('categoryChart').getContext('2d');
            const categories = { 'Fisik': 0, 'Listrik': 0, 'Kimia/Api': 0, 'Lainnya': 0 };
            reports.forEach(r => {
                if (categories[r.category] !== undefined) categories[r.category]++;
                else {
                    // Jika kategori tidak dikenal, masukkan ke Lainnya
                    categories['Lainnya'] = (categories['Lainnya'] || 0) + 1;
                }
            });

            if (chartInstance) { chartInstance.destroy(); }

            chartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(categories),
                    datasets: [{
                        data: Object.values(categories),
                        backgroundColor: ['#3b82f6', '#fbbf24', '#ef4444', '#9ca3af'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { position: 'right' } }
                }
            });
        }

        window.switchView = (viewName) => {
            const userView = document.getElementById('view-user');
            const adminView = document.getElementById('view-admin');
            const btnUser = document.getElementById('btn-user-view');
            const btnAdmin = document.getElementById('btn-admin-view');

            if (viewName === 'admin') {
                userView.classList.add('hidden-view');
                adminView.classList.remove('hidden-view');
                btnAdmin.classList.add('hidden');
                btnUser.classList.remove('hidden');
            } else {
                adminView.classList.add('hidden-view');
                userView.classList.remove('hidden-view');
                btnUser.classList.add('hidden');
                btnAdmin.classList.remove('hidden');
            }
        };

    </script>
</body>
</html>